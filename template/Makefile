MAKEFILE_DIR := $(shell dirname $(realpath $(firstword $(MAKEFILE_LIST))))
.DEFAULT_GOAL ?= help
.PHONY: help
help:
	@echo "${Project}"
	@echo "${Description}"
	@echo ""
	@echo "	drupal - deploy (monolithic)"
	# @echo ${MAKEFILE_DIR}


###################### Parameters ######################
Description ?= Drupal on ECS-Fargate with EFS and Aurora Serverless v2
# CFN Stack Parameters
Project ?= drupal
ClusterName ?= drupal-ecs
EnvironmentName ?= dev
LocalAWSRegion ?= eu-south-1  ## Using eu-south-1 for SSM Application Manager (CloudFormation Library) not available in Spain
Profile ?= sso-madmin
DrupalImage ?= drupal:latest
VpcCIDR ?= "10.200.0.0/16"
DrupalStackName ?= drupal-ecs
AccountNumber ?= $(shell aws sts get-caller-identity --profile sso-madmin --query Account --output text)

## Ubuntu 22.04 arm with nginx in eu-south-2 (Spain)
## Generated by ImageBuilder in eu-west-1, eu-south-1, eu-south-2
## TODO - use parameter store
## S3FullPath ?= "s3://demos-rp-eu-south-2/cfn/autoscaling"


#######################################################
.PHONY: all
all:  drupal

.PHONY: debug-vars
debug-vars:
	@echo "Region: ${LocalAWSRegion}"
	@echo "VPC CIDR:  ${VpcCIDR}"
	@echo "DrupalStackName: ${DrupalStackName}"
	@echo "Profile": ${Profile}

.PHONY: drupal
drupal:
	aws cloudformation deploy \
		--template-file ./template.yaml \
		--stack-name ${DrupalStackName} \
		--parameter-overrides \
			ClusterName=${ClusterName} \
			EnvironmentName=${EnvironmentName} \
		--no-fail-on-empty-changeset \
		--capabilities CAPABILITY_NAMED_IAM \
		--profile ${Profile} \
		--region ${LocalAWSRegion}
del-drupal:
	@echo "Deleting Logs Bucket"
	aws s3 rb s3://${ClusterName}-logs-${AccountNumber}-${LocalAWSRegion} \
		--force --region ${LocalAWSRegion} --profile ${Profile}
	@read -p "Are you sure that you want to destroy stack '${DrupalStackName}'? [y/N]: " sure && [ $${sure:-N} = 'y' ]
	aws cloudformation delete-stack --region ${LocalAWSRegion} --stack-name "${DrupalStackName}" --profile ${Profile}

drupal-ecs-drupaldbv2-fke74mipedu0.cluster-cuvkrtcve1fm.eu-south-1.rds.amazonaws.com